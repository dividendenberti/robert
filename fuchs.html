<!doctype html>
<html lang="de" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuchs Versicherung</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .upload-area {
      border: 2px dashed #cbd5e0;
      transition: all 0.3s ease;
    }
    
    .upload-area:hover {
      border-color: #4a5568;
      background-color: #f7fafc;
    }
    
    .upload-area.dragover {
      border-color: #d97706;
      background-color: #fffbeb;
    }
    
    .file-item {
      background-color: #f8fafc;
      border-left: 3px solid #d97706;
    }
    
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #d97706;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="w-full h-full overflow-auto" id="app-wrapper">
   <div class="min-h-full" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="max-w-4xl mx-auto px-6 py-12"><!-- Header -->
     <div class="text-center mb-12">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full mb-4 shadow-lg">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke="#d97706" class="w-12 h-12"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
      </div>
      <h1 id="page-title" class="text-5xl font-bold text-white mb-2">Fuchs Versicherung</h1>
     </div><!-- Main Card -->
     <div class="bg-white rounded-2xl shadow-2xl p-8">
      <form id="upload-form"><!-- Upload Area -->
       <div class="mb-8"><label class="block text-xl font-semibold text-gray-800 mb-4" id="upload-label"> PDF-Dateien hochladen </label>
        <div class="upload-area rounded-xl p-8 text-center cursor-pointer" id="upload-area">
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
         </svg>
         <p class="text-lg text-gray-600 mb-2">Klicken Sie hier oder ziehen Sie Dateien hierher</p>
         <p class="text-sm text-gray-500">Mehrere PDF-Dateien unterst√ºtzt</p><input type="file" id="file-input" accept=".pdf" multiple class="hidden">
        </div><!-- File List -->
        <div id="file-list" class="mt-4 space-y-2"></div>
       </div><!-- Info Text -->
       <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <p id="info-text" class="text-gray-700 leading-relaxed">Sie k√∂nnen mehrere Dateien hochladen und danach ausw√§hlen wie es bearbeitet werden soll</p>
       </div><!-- Processing Options -->
       <div class="mb-8"><label for="processing-option" class="block text-xl font-semibold text-gray-800 mb-4" id="select-label"> Bearbeitungsoption w√§hlen </label>
        <div id="loading-options" class="flex items-center justify-center py-8">
         <div class="loading-spinner"></div><span class="ml-3 text-gray-600">Lade Optionen...</span>
        </div><select id="processing-option" class="hidden w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all"> <option value="">Bitte w√§hlen Sie eine Option</option> </select>
        <p id="option-description" class="mt-2 text-sm text-gray-600 italic"></p>
       </div><!-- Submit Button --> <button type="submit" id="submit-button" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xl font-semibold py-4 px-8 rounded-xl shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"> Absenden </button>
      </form><!-- Success Message -->
      <div id="success-message" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
       <p class="text-green-800 font-semibold">‚úÖ Erfolgreich √ºbermittelt!</p>
      </div><!-- Error Message -->
      <div id="error-message" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
       <p class="text-red-800 font-semibold" id="error-text"></p>
      </div><!-- Result Display -->
      <div id="result-container" class="hidden mt-6">
       <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl p-6">
        <h2 class="text-2xl font-bold text-purple-900 mb-4">üìÑ Ergebnis</h2>
        <div id="result-content" class="bg-white rounded-lg p-6 shadow-inner max-h-96 overflow-y-auto"><!-- Result will be displayed here -->
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      page_title: "Fuchs Versicherung",
      upload_label: "PDF-Dateien hochladen",
      info_text: "Sie k√∂nnen mehrere Dateien hochladen und danach ausw√§hlen wie es bearbeitet werden soll",
      select_label: "Bearbeitungsoption w√§hlen",
      submit_button: "Absenden",
      primary_color: "#d97706",
      background_gradient_start: "#667eea",
      background_gradient_end: "#764ba2",
      card_background: "#ffffff",
      text_color: "#1f2937",
      font_family: "system-ui"
    };

    let selectedFiles = [];
    let processingOptions = [];

    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const fullFontStack = `${customFont}, ${baseFontStack}`;

      document.body.style.fontFamily = fullFontStack;
      
      document.getElementById('page-title').textContent = config.page_title || defaultConfig.page_title;
      document.getElementById('upload-label').textContent = config.upload_label || defaultConfig.upload_label;
      document.getElementById('info-text').textContent = config.info_text || defaultConfig.info_text;
      document.getElementById('select-label').textContent = config.select_label || defaultConfig.select_label;
      document.getElementById('submit-button').textContent = config.submit_button || defaultConfig.submit_button;

      const primaryColor = config.primary_color || defaultConfig.primary_color;
      document.querySelector('.upload-area').style.borderColor = '#cbd5e0';
      document.getElementById('submit-button').style.background = `linear-gradient(to right, ${primaryColor}, ${adjustColor(primaryColor, -20)})`;
    }

    function adjustColor(color, amount) {
      const num = parseInt(color.replace("#", ""), 16);
      const r = Math.max(0, Math.min(255, (num >> 16) + amount));
      const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
      const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
      return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ primary_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            if (window.elementSdk) window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["upload_label", config.upload_label || defaultConfig.upload_label],
        ["info_text", config.info_text || defaultConfig.info_text],
        ["select_label", config.select_label || defaultConfig.select_label],
        ["submit_button", config.submit_button || defaultConfig.submit_button]
      ]);
    }

    // Load processing options
    async function loadProcessingOptions() {
      try {
        console.log('Starte Laden der Optionen...');
        const credentials = btoa('prompt:wert1234');
        const response = await fetch('https://n8n.fuchs-versicherung.at/webhook/9f53e32b-2503-4556-9425-9b6d35ab2b41', {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Authorization': 'Basic ' + credentials
          }
        });
        
        console.log('Response Status:', response.status);
        console.log('Response OK:', response.ok);
        
        if (!response.ok) {
          throw new Error('Netzwerkfehler: ' + response.status);
        }
        
        const rawText = await response.text();
        console.log('Raw Response:', rawText);
        
        const data = JSON.parse(rawText);
        console.log('Erhaltene Daten:', data);
        console.log('Daten-Typ:', typeof data);
        console.log('Ist Array?', Array.isArray(data));
        
        // Handle different response formats
        if (Array.isArray(data)) {
          processingOptions = data;
        } else if (data && typeof data === 'object') {
          // If it's an object, check if it has Id/Title fields (single option)
          if (data.Id || data.id || data.Title || data.title) {
            // It's a single option object - wrap it in an array
            processingOptions = [data];
          } else if (data.options) {
            processingOptions = data.options;
          } else if (data.data) {
            processingOptions = data.data;
          } else if (data.items) {
            processingOptions = data.items;
          } else {
            // Last resort: convert object to array
            processingOptions = Object.values(data);
          }
        } else {
          processingOptions = [];
        }
        
        console.log('Verarbeitete Optionen:', processingOptions);
        
        const select = document.getElementById('processing-option');
        const loadingDiv = document.getElementById('loading-options');
        
        if (!processingOptions || processingOptions.length === 0) {
          loadingDiv.innerHTML = '<p class="text-yellow-600">Keine Optionen verf√ºgbar.<br>Antwort: ' + JSON.stringify(data).substring(0, 200) + '</p>';
          return;
        }
        
        processingOptions.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.Id || option.id;
          optionElement.textContent = option.Title || option.title || option.name;
          optionElement.dataset.description = option.kurzbezeichnung || option.description || '';
          select.appendChild(optionElement);
        });
        
        loadingDiv.classList.add('hidden');
        select.classList.remove('hidden');
        console.log('Optionen erfolgreich geladen:', processingOptions.length);
      } catch (error) {
        console.error('Fehler beim Laden:', error);
        document.getElementById('loading-options').innerHTML = '<p class="text-red-600">Fehler: ' + error.message + '<br>Bitte Browser-Konsole (F12) pr√ºfen.</p>';
      }
    }

    // File upload handling
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
      addFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      addFiles(Array.from(e.target.files));
    });

    function addFiles(files) {
      selectedFiles = [...selectedFiles, ...files];
      renderFileList();
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderFileList();
    }

    function renderFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
      }

      fileList.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item flex items-center justify-between p-4 rounded-lg">
          <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-8 h-8 text-red-600">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <div>
              <p class="font-semibold text-gray-800">${file.name}</p>
              <p class="text-sm text-gray-500">${(file.size / 1024).toFixed(1)} KB</p>
            </div>
          </div>
          <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      `).join('');
    }

    // Show option description
    document.getElementById('processing-option').addEventListener('change', (e) => {
      console.log('Dropdown ge√§ndert. Ausgew√§hlter Wert:', e.target.value);
      console.log('Alle verf√ºgbaren Optionen:', processingOptions);
      
      const selectedOption = processingOptions.find(opt => {
        const optId = opt.Id || opt.id;
        console.log('Vergleiche:', optId, '==', e.target.value, '?', optId == e.target.value);
        return optId == e.target.value;
      });
      
      console.log('Gefundene Option:', selectedOption);
      
      const descriptionEl = document.getElementById('option-description');
      
      if (selectedOption) {
        const description = selectedOption.kurzbezeichnung || selectedOption.description || '';
        console.log('Setze Beschreibung:', description);
        descriptionEl.textContent = description;
        descriptionEl.classList.remove('hidden');
      } else {
        console.log('Keine Option gefunden - leere Beschreibung');
        descriptionEl.textContent = '';
      }
    });

    // Form submission
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitButton = document.getElementById('submit-button');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      if (selectedFiles.length === 0) {
        errorText.textContent = 'Bitte laden Sie mindestens eine PDF-Datei hoch.';
        errorMessage.classList.remove('hidden');
        return;
      }
      
      const selectedOptionId = document.getElementById('processing-option').value;
      if (!selectedOptionId) {
        errorText.textContent = 'Bitte w√§hlen Sie eine Bearbeitungsoption.';
        errorMessage.classList.remove('hidden');
        return;
      }
      
      submitButton.disabled = true;
      submitButton.innerHTML = '<div class="flex items-center justify-center"><div class="loading-spinner mr-2"></div>Wird gesendet...</div>';
      
      try {
        // Prepare FormData with files and selected option
        const formData = new FormData();
        
        // Add selected option info
        const selectedOption = processingOptions.find(opt => (opt.Id || opt.id) == selectedOptionId);
        formData.append('selectedOptionId', selectedOptionId);
        if (selectedOption) {
          formData.append('selectedOptionTitle', selectedOption.Title || selectedOption.title || '');
          formData.append('selectedOptionPrompt', selectedOption.prompt || '');
        }
        
        // Add all PDF files
        selectedFiles.forEach((file, index) => {
          formData.append(`pdf_${index}`, file, file.name);
        });
        
        // Send to webhook
        const credentials = btoa('prompt:wert1234');
        const response = await fetch('https://n8n.fuchs-versicherung.at/webhook/48866296-2384-404a-bf3d-4a1f33e5cf3f', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Authorization': 'Basic ' + credentials
          },
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Fehler beim Senden: ' + response.status);
        }
        
        const result = await response.json();
        console.log('Webhook Antwort:', result);
        
        // Display result
        const resultContainer = document.getElementById('result-container');
        const resultContent = document.getElementById('result-content');
        
        // Extract data from webhook response
        let pdfData = null;
        
        if (Array.isArray(result) && result.length > 0 && result[0].data) {
          pdfData = result[0].data;
        } else if (result.data) {
          pdfData = result.data;
        }
        
        if (pdfData) {
          // Clean base64 data if it has data URI prefix
          const base64Data = pdfData.replace(/^data:application\/pdf;base64,/, '');
          
          // Create blob from base64
          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const blobUrl = URL.createObjectURL(blob);
          
          // Display PDF in iframe
          resultContent.innerHTML = `
            <div class="flex flex-col space-y-3">
              <iframe src="${blobUrl}" class="w-full h-96 border-2 border-gray-300 rounded-lg"></iframe>
              <a href="${blobUrl}" download="ergebnis.pdf" class="inline-flex items-center justify-center px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5 mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                PDF herunterladen
              </a>
            </div>
          `;
          resultContainer.classList.remove('hidden');
        } else {
          // Fallback: display the entire result as formatted JSON
          resultContent.innerHTML = '<pre class="whitespace-pre-wrap text-sm">' + JSON.stringify(result, null, 2) + '</pre>';
          resultContainer.classList.remove('hidden');
        }
        
        // Success
        submitButton.disabled = false;
        submitButton.textContent = window.elementSdk?.config?.submit_button || defaultConfig.submit_button;
        successMessage.classList.remove('hidden');
        
        // Scroll to result
        setTimeout(() => {
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 300);
        
        // Reset form
        selectedFiles = [];
        renderFileList();
        fileInput.value = '';
        document.getElementById('processing-option').value = '';
        document.getElementById('option-description').textContent = '';
        
      } catch (error) {
        console.error('Fehler beim Absenden:', error);
        errorText.textContent = 'Fehler beim Senden: ' + error.message;
        errorMessage.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = window.elementSdk?.config?.submit_button || defaultConfig.submit_button;
      }
    });

    // Initialize SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Load options on page load
    loadProcessingOptions();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b1201c221835b90',t:'MTc2NjI2Mzc3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>